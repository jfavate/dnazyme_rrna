---
title: "4-identify_rrna_frags"
format: html
---

```{r}
library(tidyverse)
library(conflicted)
library(Biostrings)
library(patchwork)
library(scales)

conflicts_prefer(dplyr::filter)
```

```{r}
pt <- theme_bw() +
  theme(
    panel.grid = element_blank(),
    legend.background = element_blank(),
    text = element_text(size = 13)
  )
```


Load the depths
```{r}
dlocs <- dir("../alignment/output", pattern = "tsv", full.names = TRUE)

names(dlocs) <- basename(dlocs) %>% 
  str_remove("\\.tsv")

ddf <- lapply(dlocs, read_tsv, col_names = FALSE) %>% 
  bind_rows(.id = "x") %>% 
  separate(x, into = c("org", "enzyme", "repl"), sep = "_")

ddf
```

There's one spot on the 23s rRNA that has way more depth than other positions, the other ones don't contribute that much 
```{r fig.width = 5.5, fig.height = 6.5}
ddf %>% 
  ggplot(., aes(X2, X3, color = repl))+
  geom_line()+
  facet_wrap(~X1, scales = "free", ncol = 1)+
  scale_y_continuous(labels = scales::label_number(scale = 1/1e6, suffix = "M"))+
  scale_color_brewer(name = "Replicate", palette = "Set1")+
  pt+
  theme(legend.text = element_text(size = 10),
        legend.title = element_text(size = 12),
        legend.position = "inside",
        legend.position.inside = c(.18,.93))+
  labs(x = "Position",
       y = "Depth")+
  guides(color = guide_legend(ncol = 2))

ggsave(plot = last_plot(), filename = "../plots/depth_on_rrna.png", width = 5.5, height = 6.5)
```

zoom
```{r fig.width = 6.5, fig.height = 3}
p.depths <- ddf %>% 
  dplyr::filter(X1 == "rna-b2589_23S_ribosomal_RNA" & X2 > 1504 & X2 < 1537) %>% 
  ggplot(., aes(X2, X3, color = repl))+
  geom_vline(aes(xintercept = 1510), linetype = 5, color = "grey30")+
  geom_vline(aes(xintercept = 1531), linetype = 5, color = "grey30")+
  geom_line()+
  facet_wrap(~X1, scales = "free", ncol = 1)+
  scale_x_continuous(breaks = seq(0,3000,1))+
  scale_y_continuous(labels = scales::label_number(scale = 1/1e6, suffix = "M"))+
  scale_color_brewer(name = "Replicate", palette = "Set1")+
  theme_bw()+
  theme(panel.grid = element_blank(),
        axis.text.x = element_blank(),
        plot.margin = unit(c(1, 1, 1, 1), "pt"),
        legend.position = "inside",
        legend.position.inside = c(.075,.78),
        legend.background = element_blank(),
        text = element_text(size = 14),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 12))+
  labs(x = NULL,
       y = "Depth")

p.depths
```

What is that sequence?
```{r}
fa <- readDNAStringSet("../references/ecoli_rrnas.fa")

theseq <- fa[names(fa) == "rna-b2589_23S_ribosomal_RNA"] %>% 
  subseq(., start = 1505, end = 1536) %>% 
  as.character() %>% 
  str_split(., "") %>% 
  unlist() %>% 
  unname()

theseq.df <- data.frame(
  l = theseq,
  x = seq(1505,1536)
)

p.theseq <- ggplot(theseq.df, aes(x, y = 1, label = l))+
  geom_text()+
  labs(x = "Position",
       y = NULL)+
  scale_x_continuous(breaks = seq(0,2000,1))+
  theme_minimal()+
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        plot.margin = unit(c(1, 1, 1, 1), "pt")
        )

p.theseq
```

```{r fig.width = 6.5, fig.height = 4.5}
(p.depths / p.theseq) + plot_layout(heights = c(.9,.1))

ggsave(plot = last_plot(), filename = "../plots/23s_overrep.png", width = 6.5, height = 4.5)
```

Presumably then, just counting the reads in the KS137 and 138 samples should show that and/or it's containments being the major species
```{bash}
for file in ../seqdata/4-filtered/*.fq.gz; do
  fname=$(basename $file | cut -d '.' -f 1)
  
  out=../raw_data/dumb_counts/${fname}.txt

  echo "zcat ${file} | awk 'NR%4==2' | sort | uniq -c | sort -nr > ${out}"
done | parallel
```

Those are quite large but it's fine
```{r}
dc.locs <- dir("../raw_data/dumb_counts", full.names = TRUE)

names(dc.locs) <- basename(dc.locs) %>% 
  str_remove("\\.txt")

d.counts <- parallel::mclapply(dc.locs, read_table, col_names = FALSE) %>% 
  bind_rows(.id = "sample")
```

Somehow, the top 7 reads in 137/138 are the same containment of reads, do a quick alignment
```{r}
d.counts %>% 
  group_by(sample) %>% 
  mutate(prop = X1 / sum(X1)*100,
         cuml = cumsum(prop)) %>% 
  ungroup() %>% 
  split(.$sample)
```

```{r}
popular.seqs <- d.counts %>% 
  filter(str_detect(sample, "KS13[78]")) %>% 
  group_by(sample) %>% 
  dplyr::slice(1:7) %>% 
  ungroup() %>% 
  pull(X2) %>% 
  unique()

fa <- DNAStringSet(popular.seqs)

names(fa) <- paste("seq", width(fa), letters[1:length(fa)], sep = "_")

writeXStringSet(fa, "abundant_23s_seqs.fa")
```

```{bash}
clustalo -i abundant_23s_seqs.fa --auto -o 23s.aln --outfmt clu
```

As expected, this one sequence is millions of reads.
```{bash}
cat 23s.aln
```

